#include "stm32g4xx.h"
#include "stm32g4xx_ll_dma.h"
#include "stm32g4xx_ll_tim.h"

DMA_HandleTypeDef hdma_tim8_up;


#define WS2812B_0   51          /* 0.3us */
#define WS2812B_1   134         /* 0.79us */

const uint32_t led_green128[] = {
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,     /* reset 300us */
    WS2812B_1,WS2812B_0,WS2812B_0,WS2812B_0,WS2812B_0,WS2812B_0,WS2812B_0,WS2812B_0, /* G */
    WS2812B_0,WS2812B_0,WS2812B_0,WS2812B_0,WS2812B_0,WS2812B_0,WS2812B_0,WS2812B_0, /* R */
    WS2812B_0,WS2812B_0,WS2812B_0,WS2812B_0,WS2812B_0,WS2812B_0,WS2812B_0,WS2812B_0, /* B */
    0xffffff
};

const uint32_t led_red128[] = {
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,     /* reset 300us */
    WS2812B_0,WS2812B_0,WS2812B_0,WS2812B_0,WS2812B_0,WS2812B_0,WS2812B_0,WS2812B_0, /* G */
    WS2812B_1,WS2812B_0,WS2812B_0,WS2812B_0,WS2812B_0,WS2812B_0,WS2812B_0,WS2812B_0, /* R */
    WS2812B_0,WS2812B_0,WS2812B_0,WS2812B_0,WS2812B_0,WS2812B_0,WS2812B_0,WS2812B_0, /* B */
    0xffffff
};
const uint32_t led_blue128[] = {
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,     /* reset 300us */
    WS2812B_0,WS2812B_0,WS2812B_0,WS2812B_0,WS2812B_0,WS2812B_0,WS2812B_0,WS2812B_0, /* G */
    WS2812B_0,WS2812B_0,WS2812B_0,WS2812B_0,WS2812B_0,WS2812B_0,WS2812B_0,WS2812B_0, /* R */
    WS2812B_1,WS2812B_0,WS2812B_0,WS2812B_0,WS2812B_0,WS2812B_0,WS2812B_0,WS2812B_0, /* B */
    0xffffff
};

const uint32_t led_off[] = {
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,     /* reset 300us */
    WS2812B_0,WS2812B_0,WS2812B_0,WS2812B_0,WS2812B_0,WS2812B_0,WS2812B_0,WS2812B_0, /* G */
    WS2812B_0,WS2812B_0,WS2812B_0,WS2812B_0,WS2812B_0,WS2812B_0,WS2812B_0,WS2812B_0, /* R */
    WS2812B_0,WS2812B_0,WS2812B_0,WS2812B_0,WS2812B_0,WS2812B_0,WS2812B_0,WS2812B_0, /* B */
    0xffffff
};

static void LedDmaComp(DMA_HandleTypeDef *_hdma)
{
    UNUSED(_hdma);
    LL_TIM_DisableCounter(TIM8);
    LL_DMA_DisableChannel(DMA2, LL_DMA_CHANNEL_2);
}

static void LedSet(const uint32_t *led, uint16_t len)
{
    HAL_DMA_RegisterCallback(&hdma_tim8_up, HAL_DMA_XFER_CPLT_CB_ID, LedDmaComp);
    LL_TIM_DisableCounter(TIM8);
    LL_DMA_DisableChannel(DMA2, LL_DMA_CHANNEL_2);
    LL_TIM_EnableAllOutputs(TIM8);
    LL_DMA_ConfigTransfer(DMA2,
                            LL_DMA_CHANNEL_2,
                            LL_DMA_DIRECTION_MEMORY_TO_PERIPH | LL_DMA_PRIORITY_LOW | LL_DMA_MODE_NORMAL |
                            LL_DMA_PERIPH_NOINCREMENT | LL_DMA_MEMORY_INCREMENT |
                            LL_DMA_PDATAALIGN_WORD | LL_DMA_MDATAALIGN_WORD);
    LL_DMA_ConfigAddresses(DMA2,
                            LL_DMA_CHANNEL_2,
                            (uint32_t)led, (uint32_t)&(TIM8->CCR1),
                            LL_DMA_GetDataTransferDirection(DMA2, LL_DMA_CHANNEL_2));

    LL_DMA_SetDataLength(DMA2, LL_DMA_CHANNEL_2, len/4);
    LL_DMA_EnableChannel(DMA2, LL_DMA_CHANNEL_2);
    LL_TIM_ConfigDMABurst(TIM8, LL_TIM_DMABURST_BASEADDR_CCR1, LL_TIM_DMABURST_LENGTH_1TRANSFER);
    LL_TIM_EnableDMAReq_UPDATE(TIM8);
    LL_DMA_EnableIT_TC(DMA2, LL_DMA_CHANNEL_2);
    TIM8->CCR1 = 0;
    LL_TIM_CC_EnableChannel(TIM8, LL_TIM_CHANNEL_CH1);
    LL_TIM_EnableCounter(TIM8);
}


void LedInit(void)
{
    LedSet(led_off, sizeof(led_off));
}


void LedGreen(void)
{
    LedSet(led_green128, sizeof(led_green128));
}

void LedRed(void)
{
    LedSet(led_red128, sizeof(led_green128));
}

void LedBlue(void)
{
    LedSet(led_red128, sizeof(led_green128));
}

